<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ì‹ë‹¹ ìƒì„¸í˜ì´ì§€</title>
        <%- include('include/head') %>
        <link rel="stylesheet" href="/static/css/restDetail.css" />
        <script
            type="text/javascript"
            src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=czcpt81ovb"
        ></script>
        <script
            type="text/javascript"
            src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=czcpt81ovb&submodules=geocoder"
        ></script>
        <script src="https://kit.fontawesome.com/9ff27f4d50.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <%- include('include/header'), {isLogin: isLogin, user: user} %>
        <main>
            <div class="rest">
                <div class="restImg">
                    <img src="/static/images/<%= restaurant.rest_index %>.png" alt="ì‹ë‹¹ ì´ë¯¸ì§€" />
                </div>
                <div class="restInfo">
                    <div class="restTitle">
                        <div class="restNameCate">
                            <span style="font-size: 30px; font-weight: bold"
                                ><%= restaurant.rest_name %></span
                            >
                            <% for (category of categoryList) { %>
                            <span style="margin-left: 20px; font-size: 20px; color: gray"
                                ><%= category.category_name %></span
                            >
                            <% } %>
                        </div>
                        <div class="restRankLike">
                            <span class="reviewCount">ë¦¬ë·° ìˆ˜: <%=reviewList.length%></span>
                            <!-- ë³„ì  -->
                            <i class="fa-solid fa-star fa-2xl" style="color: #ffd43b"></i>
                            <% let rating = 0%>
                            <!-- ë¦¬ë·°ê°€ ìˆì„ ë•Œ -->
                            <% if (reviewList.length > 0) { %> <% for (review of reviewList) { %> <%
                            rating += review.review_rating %> <% } %>
                            <!-- í‰ê· , ì†Œìˆ˜ì  ì²« ë²ˆì§¸ ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼ -->
                            <span class="rating"
                                ><%= (rating / reviewList.length).toFixed(1) %></span
                            >
                            <% } else { %>
                            <span class="rating">0</span>
                            <% } %>
                            <!-- ì±„ìš´ í•˜íŠ¸ fa-regular -> fa-solid -->

                            <% if (!likeCheckResult) { %>
                            <!-- ë¡œê·¸ì¸ x, ë¡œê·¸ì¸ o ì¢‹ì•„ìš” x -->
                            <i
                                id="emptyHeart"
                                class="fa-regular fa-heart fa-2xl"
                                style="color: #ff0000"
                                onclick="likePlus('<%= restaurant.rest_index%>', '<%= isLogin %>')"
                            ></i>
                            <% } else { %>
                            <!-- ë¡œê·¸ì¸ o ì¢‹ì•„ìš” o -->
                            <i
                                id="filledHeart"
                                class="fa-solid fa-heart fa-2xl"
                                style="color: #ff0000"
                                onclick="likePlus('<%= restaurant.rest_index%>', '<%= isLogin %>')"
                            ></i>
                            <% } %>
                        </div>
                    </div>
                    <hr />
                    <div class="restDes">
                        <p><%= restaurant.rest_desc%></p>
                        <br />
                        <div class="otherInfo">
                            <div class="timeAndNum">
                                â° ì˜ì—…ì‹œê°„: <%= restaurant.rest_time%><br /><br />
                                ğŸ“ ë²ˆí˜¸: <%= restaurant.rest_number%><br /><br />
                            </div>
                            <div class="menu">
                                ğŸ“œ ëŒ€í‘œë©”ë‰´:
                                <!-- ë©”ë‰´ ì •ë³´ê°€ ìˆì„ ë•Œ -->
                                <% if (menuList.length > 0) { %>
                                <ul>
                                    <% for (menu of menuList) { %>
                                    <li>
                                        <span><%=menu.menu%></span> ------------- <%=menu.price%>ì›
                                    </li>
                                    <% } %>
                                </ul>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ì§€ë„ -->
            <div class="maps">
                <div class="address">ì£¼ì†Œ: <%= restaurant.rest_address%></div>
                <div id="map"></div>
            </div>
            <script>
                const address = "<%=restaurant.rest_address%>";
                let lat, lng;
                // console.log(address);
                function geo() {
                    return new Promise((resolve, reject) => {
                        naver.maps.Service.geocode(
                            {
                                query: address,
                            },
                            function (status, response) {
                                if (status !== naver.maps.Service.Status.OK) {
                                    reject("ì£¼ì†Œ -> ìœ„ë„,ê²½ë„ ë³€í™˜ error");
                                }
                                let result = response.v2; // ê²€ìƒ‰ ê²°ê³¼ì˜ ì»¨í…Œì´ë„ˆ
                                let items = result.addresses; // ê²€ìƒ‰ ê²°ê³¼ì˜ ë°°ì—´
                                lat = items[0].x;
                                lng = items[0].y;
                                resolve(); // Promiseë¥¼ ì´ìš©í•˜ì—¬ ë¹„ë™ê¸° ë™ì‘ì´ ì™„ë£Œë¨ì„ ì•Œë¦¼
                            }
                        );
                    });
                }
                function map() {
                    // console.log("lat, lng >> ",lat, lng);

                    // ì§€ë„ ìœ„ì¹˜(x:ê²½ë„, y:ìœ„ë„), ì¤Œ, ì»¨íŠ¸ë¡¤ ì„¤ì •
                    let mapOptions = {
                        center: new naver.maps.LatLng(lng, lat),
                        zoom: 18,
                        scaleControl: false,
                        mapDataControl: false,
                        zoomControl: true,
                    };

                    // mapOptionsì˜ ì˜µì…˜ìœ¼ë¡œ map ìƒì„±
                    let map = new naver.maps.Map("map", mapOptions);

                    // ì§€ë„ ë§ˆì»¤ ì„¤ì •
                    let marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(lng, lat),
                        map: map,
                    });
                }
                async function geoAndMap() {
                    await geo();
                    map();
                }

                geoAndMap();
            </script>

            <div class="reviewAll">
                <h2 class="reviewTitle">ë¦¬ë·°</h2>
                <div class="reviews">
                    <% let reviewCount = 0; %>
                    <!-- ë¦¬ë·° ê°œìˆ˜ 1ê°œ -->
                    <% if (reviewList.length === 1) {%> <% for (let i = 0; i < reviewList.length;
                    i++) { %>
                    <div class="review">
                        <div class="reviewTitle">
                            <i class="fa-regular fa-user fa-xl"></i>
                            <span><%= reviewList[i].User.nickname%> | </span>
                            <% const originalDate = new Date(reviewList[i].createdAt); const
                            formattedDate = originalDate.toLocaleString('ko-KR', {timeZone:
                            'Asia/Seoul', hour12: false}); %>
                            <span><%=formattedDate %></span>
                            <span class="reviewRating">
                                <% for(let j = 0; j < reviewList[i].review_rating; j++) { %>
                                <i class="fa-solid fa-star fa-xl" style="color: #ffd43b"></i>
                                <% } %>
                            </span>
                        </div>
                        <hr />
                        <p><%= reviewList[i].review_content%></p>
                    </div>
                    <% } %> <% } else if(reviewList.length >= 2) { %>
                    <!-- ë¦¬ë·° ê°œìˆ˜ 2ê°œ ì´ìƒ -->
                    <% for (let i = 0; i < 2; i++) { %>
                    <div class="review">
                        <div class="reviewTitle">
                            <i class="fa-regular fa-user fa-xl"></i>
                            <span><%= reviewList[i].User.nickname%> | </span>
                            <% const originalDate = new Date(reviewList[i].createdAt); const
                            formattedDate = originalDate.toLocaleString('ko-KR', {timeZone:
                            'Asia/Seoul', hour12: false}); %>
                            <span><%=formattedDate %></span>
                            <span class="reviewRating">
                                <% for(let j = 0; j < reviewList[i].review_rating; j++) { %>
                                <i class="fa-solid fa-star fa-xl" style="color: #ffd43b"></i>
                                <% } %>
                            </span>
                        </div>
                        <hr />
                        <p><%= reviewList[i].review_content%></p>
                    </div>
                    <% } %> <% if (reviewList.length > 2) { %>
                    <button
                        id="reviewPlusBtn"
                        type="button"
                        onclick="reviewPlus('<%= restaurant.rest_index%>', this)"
                    >
                        ë¦¬ë·° ë”ë³´ê¸° +
                    </button>
                    <% } %> <% } %>
                </div>
                <hr />
                <div class="createReview">
                    <div class="rating">
                        <span>
                            <%for (let i=1; i<=5; i++) { %>
                            <i
                                id="ratingCount<%= i %>"
                                class="fa-regular fa-star fa-2xl"
                                style="color: #ffd43b"
                                onclick="reviewRating('<%= restaurant.rest_index%>', this)"
                            ></i>
                            <%} %>
                        </span>
                    </div>
                    <textarea
                        maxlength="255"
                        class="createReviewContent"
                        name="create_review"
                        cols="92"
                        rows="3"
                        placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
                    ></textarea>
                    <button
                        type="button"
                        onclick="createReview('<%= restaurant.rest_index %>', '<%= isLogin %>')"
                    >
                        ë¦¬ë·° ë“±ë¡í•˜ê¸°
                    </button>
                </div>
            </div>
        </main>
        <%- include('include/footer') %>
    </body>

    <script>
        function likePlus(restIndex, isLogin) {
            // ë¡œê·¸ì¸ ë˜ì–´ìˆì„ ë•Œ
            // console.log("ë¡œê·¸ì¸ ìƒíƒœ >> ",isLogin)
            if (isLogin === "true") {
                const filledHeart = document.querySelector("#filledHeart");
                // console.log(filledHeart)
                // ì±„ì›Œì§„ í•˜íŠ¸ ì¢‹ì•„ìš” o) ë¼ë©´
                if (filledHeart) {
                    // ì±„ì›Œì§„ í•˜íŠ¸ fa-solid, ë¹ˆ í•˜íŠ¸ fa-regular
                    // ì¢‹ì•„ìš” ì‚­ì œ í›„ ë¹ˆí•˜íŠ¸
                    axios({
                        url: `/restaurantDetail/${restIndex}/deleteLike`,
                        method: "delete",
                        data: { restIndex: restIndex },
                    })
                        .then((response) => {
                            filledHeart.id = "emptyHeart";
                            filledHeart.classList.remove("fa-solid");
                            filledHeart.classList.add("fa-regular");
                            // console.log(response)
                            alert(response.data.message);
                        })
                        .catch((err) => {
                            alert("ì¢‹ì•„ìš” ì‚­ì œ ì‹¤íŒ¨");
                            console.log("err", err);
                        });
                } else {
                    // ë¹ˆ í•˜íŠ¸ (ë¡œê·¸ì¸ o ì¢‹ì•„ìš” x) ë¼ë©´
                    const emptyHeart = document.querySelector("#emptyHeart");
                    // console.log(emptyHeart);
                    // ì¢‹ì•„ìš” ë“±ë¡ í›„ ì±„ì›Œì§„ í•˜íŠ¸
                    axios({
                        url: `/restaurantDetail/${restIndex}/createLike`,
                        method: "post",
                        data: { restIndex: restIndex },
                    })
                        .then((response) => {
                            emptyHeart.id = "filledHeart";
                            emptyHeart.classList.remove("fa-regular");
                            emptyHeart.classList.add("fa-solid");
                            // console.log(response)
                            alert(response.data.message);
                        })
                        .catch((err) => {
                            alert("ì¢‹ì•„ìš” ë“±ë¡ ì‹¤íŒ¨");
                            console.log("err", err);
                        });
                }
            } else {
                // ë¡œê·¸ì¸ ì•ˆë˜ì–´ìˆì„ ë•Œ
                return alert("ì¢‹ì•„ìš” ë“±ë¡ì€ ë¡œê·¸ì¸ì´ ëœ ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!");
            }
        }

        // ë”ë³´ê¸° ì²˜ìŒ ë°œìƒ ì‹œ reviewê°œìˆ˜ëŠ” 2ê°œ, í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë¦¬ë·° ê°œìˆ˜
        let reviewCount = 2;

        function reviewPlus(restIndex) {
            axios({
                url: `/restaurantDetail/${restIndex}/reviewPlus`,
                method: "get",
                params: { restIndex: restIndex },
            })
                .then((response) => {
                    // console.log(response.data.reviewList);
                    const reviewList = response.data.reviewList;
                    // ë¦¬ë·°ê°€ ë”ë³´ê¸° í•  ë¦¬ë·°ê°€ ì—†ì„ ë•Œ
                    if (reviewCount === reviewList.length) {
                        return alert("ë¦¬ë·°ê°€ ë” ì´ìƒ ì—†ìŠµë‹ˆë‹¤!");
                    }
                    // console.log(reviewList);
                    // ë”ë³´ê¸° ë¦¬ë·°ê°€ 1ê°œ ë‚¨ì•˜ì„ ë•Œ
                    if (reviewList.length - reviewCount === 1) {
                        for (let i = reviewCount; i < reviewCount + 1; i++) {
                            // console.log(reviewList[i].review_content);
                            // ë¦¬ë·° ì „ì²´ ê°ì‹¸ëŠ” div
                            const plusReview = document.createElement("div");
                            plusReview.classList.add("review");

                            // ë¦¬ë·° íƒ€ì´í‹€ divì™€ ì½˜í…ì¸  p
                            const reviewTitle = document.createElement("div");
                            reviewTitle.classList.add("reviewTitle");
                            const hr = document.createElement("hr");
                            const content = document.createElement("p");
                            content.textContent = reviewList[i].review_content;
                            plusReview.append(reviewTitle, hr, content);

                            // ìœ ì €ì´ë¯¸ì§€, ë‹‰ë„¤ì„, ìƒì„±ì¼, ë³„ì 
                            const userImage = document.createElement("i");
                            const userNickname = document.createElement("span");
                            const createAt = document.createElement("span");
                            const rating = document.createElement("span"); // reviewRating í´ë˜ìŠ¤

                            // <i class="fa-regular fa-user fa-xl"></i> ìœ ì € ì´ë¯¸ì§€
                            userImage.classList.add("fa-regular");
                            userImage.classList.add("fa-user");
                            userImage.classList.add("fa-xl");
                            userNickname.textContent = `${reviewList[i].User.nickname} | `;
                            const originalDate = new Date(reviewList[i].createdAt);
                            const formattedDate = originalDate.toLocaleString("ko-KR", {
                                timeZone: "Asia/Seoul",
                                hour12: false,
                            });
                            createAt.textContent = formattedDate;
                            rating.classList.add("reviewRating");
                            for (let j = 0; j < reviewList[i].review_rating; j++) {
                                const ratingOne = document.createElement("i");
                                ratingOne.classList.add("fa-solid");
                                ratingOne.classList.add("fa-star");
                                ratingOne.classList.add("fa-xl");
                                ratingOne.style.color = "#FFD43B";
                                rating.append(ratingOne);
                            }
                            reviewTitle.append(userImage, userNickname, createAt, rating);
                            const reviews = document.querySelector(".reviews");
                            const reviewPlusBtn = document.querySelector("#reviewPlusBtn");
                            // console.log(reviewPlusBtn)
                            reviews.insertBefore(plusReview, reviewPlusBtn);
                        }
                        reviewCount += 1;
                        // 2ê°œì´ìƒ ë‚¨ì•˜ì„ ë•Œ
                    } else {
                        // 3ë²ˆì§¸ ë¦¬ë·° ë¶€í„° 2ê°œì¶”ê°€
                        for (let i = reviewCount; i < reviewCount + 2; i++) {
                            // console.log(reviewList[i].review_content);
                            // ë¦¬ë·° ì „ì²´ ê°ì‹¸ëŠ” div
                            const plusReview = document.createElement("div");
                            plusReview.classList.add("review");

                            // ë¦¬ë·° íƒ€ì´í‹€ divì™€ ì½˜í…ì¸  p
                            const reviewTitle = document.createElement("div");
                            reviewTitle.classList.add("reviewTitle");
                            const hr = document.createElement("hr");
                            const content = document.createElement("p");
                            content.textContent = reviewList[i].review_content;
                            plusReview.append(reviewTitle, hr, content);

                            // ìœ ì €ì´ë¯¸ì§€, ë‹‰ë„¤ì„, ìƒì„±ì¼, ë³„ì 
                            const userImage = document.createElement("i");
                            const userNickname = document.createElement("span");
                            const createAt = document.createElement("span");
                            const rating = document.createElement("span"); // reviewRating í´ë˜ìŠ¤

                            // <i class="fa-regular fa-user fa-xl"></i> ìœ ì € ì´ë¯¸ì§€
                            userImage.classList.add("fa-regular");
                            userImage.classList.add("fa-user");
                            userImage.classList.add("fa-xl");
                            userNickname.textContent = `${reviewList[i].User.nickname} | `;
                            const originalDate = new Date(reviewList[i].createdAt);
                            const formattedDate = originalDate.toLocaleString("ko-KR", {
                                timeZone: "Asia/Seoul",
                                hour12: false,
                            });
                            createAt.textContent = formattedDate;
                            rating.classList.add("reviewRating");
                            for (let j = 0; j < reviewList[i].review_rating; j++) {
                                const ratingOne = document.createElement("i");
                                ratingOne.classList.add("fa-solid");
                                ratingOne.classList.add("fa-star");
                                ratingOne.classList.add("fa-xl");
                                ratingOne.style.color = "#FFD43B";
                                rating.append(ratingOne);
                            }
                            reviewTitle.append(userImage, userNickname, createAt, rating);
                            const reviews = document.querySelector(".reviews");
                            const reviewPlusBtn = document.querySelector("#reviewPlusBtn");
                            // console.log(reviewPlusBtn)
                            reviews.insertBefore(plusReview, reviewPlusBtn);
                        }
                        reviewCount += 2;
                    }
                })
                .catch((err) => {
                    alert("ë¦¬ë·° ë”ë³´ê¸° ì‹¤íŒ¨");
                    console.log("err", err);
                });
        }

        // í˜„ì¬ ì„ íƒí•œ ë³„ì  ìˆ˜
        let selectRating = 0;
        function reviewRating(restIndex, click) {
            console.log("í´ë¦­ì´ ë°œìƒí•œ ìš”ì†Œì˜ id ê°’:", click.id);
            selectRating = Number(click.id[click.id.length - 1]);
            console.log("ì„ íƒí•œ ë³„ì  ìˆ˜ >", selectRating);

            // ì„ íƒí•œ ë³„ì ë³´ë‹¤ ë” ì±„ì›ì§„ ë³„ ë¹ˆ ë³„ë¡œ
            for (let i = selectRating + 1; i <= 5; i++) {
                const ratingChange = document.querySelector(`#ratingCount${i}`);
                if (ratingChange.classList.contains("fa-solid")) {
                    ratingChange.classList.remove("fa-solid");
                    ratingChange.classList.add("fa-regular");
                }
            }
            // ì„ íƒí•œ ë³„ë§Œí¼ ë¹ˆ ë³„ ì±„ì›Œì£¼ê¸°
            for (let i = 1; i <= selectRating; i++) {
                const ratingChange = document.querySelector(`#ratingCount${i}`);
                if (ratingChange.classList.contains("fa-regular")) {
                    ratingChange.classList.remove("fa-regular");
                    ratingChange.classList.add("fa-solid");
                }
            }

            // for(let i = 1; i <= createRating; i++) {
            //     const ratingChange = document.querySelector(`#ratingCount${i}`);
            //     ratingChange.classList.remove("fa-regular");
            //     ratingChange.classList.add("fa-solid");
            // }
        }

        async function createReview(restIndex, isLogin) {
            if (isLogin === "true") {
                // console.log("review ë“±ë¡");
                const contentArea = document.querySelector(".createReviewContent");
                const content = contentArea.value;
                if (selectRating === 0) {
                    return alert("ë³„ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                }

                if (content === "") {
                    return alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                }

                if (confirm("ë¦¬ë·°ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    // ë¦¬ë·° ë“±ë¡ ìš”ì²­
                    await axios({
                        url: `/restaurantDetail/${restIndex}/createReview`,
                        method: "post",
                        data: { restIndex: restIndex, rating: selectRating, content: content },
                    })
                        .then((response) => {
                            alert(response.data.message);
                        })
                        .catch((err) => {
                            alert("ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨ err");
                            console.log("err", err);
                        });

                    // í˜„ì¬ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨
                    location.reload();
                }
            } else {
                alert("ë¦¬ë·°ë¥¼ ë“±ë¡í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ ëœ ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!");
            }
        }
    </script>
</html>
